# 前期设计
## 需求分析
### 数据需求
对于从实体的属性以及实体间联系抽象出属性，可以得出数据类型只有三类： $date$ 类型用于记录日期， $char$ 类型用于记录信息， $int$ 类型用于记录状态
### 功能需求
关于需要实现的功能，涉及到基本表的增删改查，在逾期未归还图书时使用触发器修改学生借阅表中的信息标记为逾期，使用存储过程结合事务编程进行借阅，预约图书，使用存储过程进行部分查询，同时在管理图书时涉及到对文件的管理
### 其他需求
考虑到真实情况以及后续数据库 $3NF$ 的关系模式实现，本次实验中并不考虑图书管理员参与学生预定和借阅图书(否则图书管理员与学生之间的联系必然涉及图书的唯一标识：图书号，而这会影响数据库关系模式的设计)，因此仅考虑学生逾期未还图书后需要与图书管理员进行交互归还逾期图书
## ER图
本次实验的 $ER$ 图如下所示
![[3041719066287_.pic.jpg]]
## 模式设计
本次实验的模式设计如下所示
 $\text{图书}(\underline{\text{图书号}}\text{,书名,作者,借阅状态,预约信息})$ 
 $\text{学生}(\underline{\text{学号}}\text{,姓名})$ 
 $\text{借阅}(\underline{\text{图书号}},\underline{\text{学号}},\underline{\text{借阅日期}}\text{,归还日期})$ 
 $\text{预约}(\underline{\text{图书号}},\underline{\text{学号}},\underline{\text{预约日期}}\text{,取书时间})$
 $\text{图书管理员}(\underline{\text{工号}}\text{,姓名})$ 
本次实验中仅设计了用户端，故学生在图书管理员处进行逾期图书的归还并未体现在上述模式设计中
# 实现说明
## 框架结构
代码的主体框架如下所示，运行 $main.py$ 调用 $gui.py$ 中的 $management\_window$ 函数，展示交互主界面
![[截屏2024-06-22 15.35.24.png]]
 $gui.py$ 文件中，在上述的 $management\_window$ 创建交互界面后，按钮分别调用函数在主界面的基础上创建相应的窗口，这些新窗口中包含输入框与确定按钮
![[截屏2024-06-22 15.41.51.png]]
点击相应的确定按钮后，会根据输入调用 $sql.py$ 文件中的相应函数，执行 $sql$ 语句并获取其结果，最后会根据这些返回的结果再次创建新窗口进行结果展示
![[截屏2024-06-22 15.49.17.png]]
## 核心代码解析
在 $management\_window$ 函数中，首先创建一个新窗口，标题命名为图书管理系统，设置画布，设置按钮及其相应的调用函数，调整按钮的大小和字体的大小，并设置圆形背景
![[截屏2024-06-22 15.54.16.png]]
![[截屏2024-06-22 15.55.22.png]]
对于后续创建的新窗口，这里以 $borrow\_window$ 为例进行详细说明
首先依然创建一个新的窗口用以交互，这里以借书为例，使用 $student\ id$ 和 $book\ id$ 和数据库进行交互，首先创建相应文本，随后创建相应的文本输入框，设置确定按钮并调用相应的 $confirm$ 函数， $confirm$ 函数中首先获得文本输入框中的输入内容，随后调用 $sql.py$ 文件中相应的函数在数据库中进行查询，获取结果保存在 $result$ 中，再次创建新窗口来展示结果
![[截屏2024-06-22 16.03.18.png]]
对于 $sql.py$ 中的文件，以 $borrow$ 函数为例， $borrow$ 函数中通过获取的输入 $studentid$ 和 $booked$ 通过执行数据库中相应的存储过程，通过 $fetchone$ 获取其执行结果，最后关闭与数据库的连接即可
![[截屏2024-06-22 21.18.56.png]]
其中 $connect\_to\_db$ 仅用于连接到数据库，具体代码如下所示，这里为了保护个人信息不显示相应用户名和密码
![[截屏2024-06-22 21.29.13.png]]
对于 $lab2.sql$ 中的相应函数，其中涉及的建立基本表，插入数据的过程是即为简单的，这里不再给予展示，对于 $BorrowBook$ 存储过程，其具体实现如下所示，分别考虑借阅失败的条件，依次实现相应记录即可
![[截屏2024-06-22 21.33.39.png]]
类似的，对于存储过程 $ReturnBook$ ，其实现代码如下所示，加入 $ncheck$ 输入变量控制是否考虑日期，使得归还逾期图书时无需再次实现还书的存储过程。对于逾期图书，无法正常还书，需要通过逾期还书这个额外功能实现
![[截屏2024-06-22 21.35.21.png]]
在逾期还书的处理过程中，随机选择一个编号的管理员，通过这个管理员进行还书操作，相应的代码如下所示
![[截屏2024-06-22 21.43.21.png]]
## 仓库地址
本次实验的全部文件可以通过 https://github.com/auiwjli/USTC-Course/tree/main/DataBase/lab2 获取，另外压缩包中也包含了全部代码
# 结果展示
首先运行 $main$ 函数，可以得到以下主界面
![[截屏2024-06-22 21.46.28.png]]
对于文件的管理，如上述实现说明中所述，将文件路径作为属性保存到基本表中，进行查询时获取文件路径进行图片的展示
![[截屏2024-06-22 15.32.36.png]]
例如当查询 $bookid$ 为 $'B001'$ 时，可以得到以下结果
![[截屏2024-06-22 15.33.19.png]]
使用逾期查询时，以 $R001$ 为例
![[截屏2024-06-22 21.49.14.png]]
可以得到以下结果
![[截屏2024-06-22 21.50.01.png]]
以下展示 $R001$ 通过正常归还来归还逾期图书 $B002$ 的结果，可以看出这样的无法归还是符合本次图书管理系统的实现需求的
![[截屏2024-06-22 21.53.18.png]]
以下展示通过逾期归还进行图书归还
![[截屏2024-06-22 21.55.11.png]]
再次进行逾期查询时，可以通过对比得出逾期归还图书的功能得到了正常实现
![[截屏2024-06-22 21.55.51.png]]
以下展示 $R001$ 分别在尚未预约与尚未借阅时试图借阅与归还图书 $B008$ ，在借阅与归还功能的实现中考虑到了这些条件，可以看到这两个错误都得到了正确处理
![[截屏2024-06-22 22.01.45.png]]
![[截屏2024-06-22 22.02.18.png]]
随后设置 $R001$ 预约图书 $B008$ ，这里预约时使用当前日期后的任意日期均可，可以得到以下结果
![[截屏2024-06-22 22.03.28.png]]
再次设置 $R001$ 借阅与归还图书 $B008$ ，可以得到以下借阅与归还功能正常执行时的结果
![[截屏2024-06-22 22.05.23.png]]
![[截屏2024-06-22 22.05.51.png]]
